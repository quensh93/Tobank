{
  "$schema": "tobank-sdui/v1/bpms-step",
  "version": "1.0.0",
  "stepId": "parsa_loan_contract",
  "flowId": "parsa_loan",
  "stepNumber": 5,
  "title": {"fa": "امضای قرارداد", "en": "Sign Contract"},
  
  "appBar": {"type": "bpms_stepper", "title": {"fa": "وام پارسا", "en": "Parsa Loan"}, "currentStep": 5, "totalSteps": 6},
  
  "body": {
    "type": "scrollable",
    "padding": 16,
    "children": [
      {"type": "card", "padding": 20, "child": {"type": "column", "children": [
        {"type": "text", "text": {"fa": "خلاصه وام", "en": "Loan Summary"}, "style": "titleLarge", "textAlign": "center"},
        {"type": "divider", "margin": {"vertical": 16}},
        {"type": "info_row", "label": {"fa": "مبلغ وام", "en": "Amount"}, "value": "{{formatCurrency(summary.amount)}} ریال", "valueColor": "#673AB7"},
        {"type": "info_row", "label": {"fa": "مدت", "en": "Term"}, "value": "{{summary.months}} ماه", "margin": {"top": 8}},
        {"type": "info_row", "label": {"fa": "قسط ماهیانه", "en": "Installment"}, "value": "{{formatCurrency(summary.installment)}} ریال", "margin": {"top": 8}},
        {"type": "info_row", "label": {"fa": "حساب واریز", "en": "Account"}, "value": "{{summary.accountNumber}}", "margin": {"top": 8}}
      ]}},
      
      {"type": "card", "margin": {"top": 24}, "child": {"type": "column", "children": [
        {"type": "container", "height": 200, "padding": 16, "child": {"type": "scrollable", "child": {"type": "text", "text": "{{contractText}}", "style": "bodySmall"}}},
        {"type": "divider"},
        {"type": "container", "padding": 12, "child": {"type": "text_button", "icon": "assets/icons/ic_download.svg", "label": {"fa": "دانلود متن کامل", "en": "Download"}, "onTap": {"type": "download", "url": "{{contractPdfUrl}}"}}}
      ]}},
      
      {"type": "section", "margin": {"top": 24}, "header": {"title": {"fa": "احراز هویت", "en": "Identity Verification"}}, "child": {
        "type": "conditional",
        "condition": "{{!ekycDone}}",
        "whenTrue": {"type": "elevated_button", "label": {"fa": "شروع احراز هویت", "en": "Start Verification"}, "fullWidth": true, "onTap": {"type": "start_ekyc", "onSuccess": {"type": "set_state", "key": "ekycDone", "value": true}}},
        "whenFalse": {"type": "container", "padding": 16, "decoration": {"color": "#E8F5E9", "borderRadius": 8}, "child": {"type": "row", "mainAxisAlignment": "center", "children": [{"type": "icon", "icon": "assets/icons/ic_check_circle.svg", "color": "#4CAF50"}, {"type": "sized_box", "width": 8}, {"type": "text", "text": {"fa": "هویت تایید شد", "en": "Verified"}, "color": "#4CAF50"}]}}
      }},
      
      {"type": "checkbox_tile", "margin": {"top": 24}, "title": {"fa": "شرایط قرارداد را می‌پذیرم", "en": "I accept the terms"}, "bindTo": "accepted"},
      {"type": "sized_box", "height": 100}
    ]
  },
  
  "bottomBar": {"type": "container", "padding": 16, "child": {"type": "row", "children": [
    {"type": "expanded", "child": {"type": "outlined_button", "label": {"fa": "قبلی", "en": "Back"}, "onTap": {"type": "navigate_back"}}},
    {"type": "sized_box", "width": 16},
    {"type": "expanded", "flex": 2, "child": {"type": "elevated_button", "label": {"fa": "امضا و دریافت", "en": "Sign & Receive"}, "disabled": "{{!ekycDone || !accepted}}", "onTap": {"type": "api_call", "endpoint": "bpms/parsa-loan/sign", "method": "POST", "requireEkycSign": true, "showLoading": true, "loadingText": {"fa": "در حال واریز...", "en": "Processing..."}, "onSuccess": {"type": "navigate_replace", "route": "/bpms/parsa-loan/step-06"}}}}
  ]}},
  
  "dataBindings": {
    "summary": {"source": "api", "endpoint": "bpms/parsa-loan/summary"},
    "contractText": {"source": "api", "endpoint": "bpms/parsa-loan/contract"},
    "ekycDone": {"source": "state", "default": false},
    "accepted": {"source": "form", "default": false}
  },
  
  "mockData": {
    "summary": {
      "amount": 1000000000,
      "months": 12,
      "installment": 94000000,
      "accountNumber": "۰۱۰۸۱۲۳۴۵۶۷۸۹۰"
    },
    "contractText": "قرارداد تسهیلات پارسا\n\nماده ۱: موضوع قرارداد...\nماده ۲: مبلغ و شرایط...\nماده ۳: نحوه بازپرداخت...\nماده ۴: تعهدات متقاضی..."
  }
}

