rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // Helper Functions
    // ============================================================================
    
    /// Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /// Check if the user has admin role
    /// Admin role can be set in custom claims OR in the user_roles collection
    function isAdmin() {
      return isAuthenticated() && (
        // Check custom claims first (set via Firebase Admin SDK)
        request.auth.token.get('admin', false) == true ||
        // Fallback to user_roles collection
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.admin == true
      );
    }
    
    /// Validate STAC screen document structure
    function isValidScreen(screen) {
      return screen.keys().hasAll(['version', 'updated_at', 'json']) &&
             screen.version is int &&
             screen.version > 0 &&
             screen.updated_at is timestamp &&
             screen.json is map;
    }
    
    /// Validate STAC config document structure
    function isValidConfig(config) {
      return config.keys().hasAll(['json', 'updated_at']) &&
             config.updated_at is timestamp &&
             config.json is map;
    }
    
    /// Check if the screen JSON has required fields
    function hasRequiredJsonFields(json) {
      return json.keys().hasAll(['type']);
    }
    
    /// Validate version increment (for updates)
    function isValidVersionUpdate(newVersion, oldVersion) {
      return newVersion == oldVersion + 1;
    }
    
    // ============================================================================
    // STAC Screens Collection
    // ============================================================================
    
    match /stac_screens/{screenName} {
      // Anyone authenticated can read screens
      // This allows the app to fetch UI configurations
      allow read: if isAuthenticated();
      
      // Only admins can create new screens
      // Validates document structure and JSON format
      allow create: if isAdmin() && 
                      isValidScreen(request.resource.data) &&
                      hasRequiredJsonFields(request.resource.data.json) &&
                      request.resource.data.version == 1;
      
      // Only admins can update screens
      // Validates structure and ensures version is incremented
      allow update: if isAdmin() && 
                      isValidScreen(request.resource.data) &&
                      hasRequiredJsonFields(request.resource.data.json) &&
                      isValidVersionUpdate(
                        request.resource.data.version,
                        resource.data.version
                      );
      
      // Only admins can delete screens
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // STAC Config Collection
    // ============================================================================
    
    match /stac_config/{configName} {
      // Anyone authenticated can read configurations
      // This includes navigation, theme, and other app-wide configs
      allow read: if isAuthenticated();
      
      // Only admins can create new configurations
      allow create: if isAdmin() && isValidConfig(request.resource.data);
      
      // Only admins can update configurations
      allow update: if isAdmin() && isValidConfig(request.resource.data);
      
      // Only admins can delete configurations
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // STAC Version History Collection
    // ============================================================================
    
    match /stac_versions/{versionId} {
      // Anyone authenticated can read version history
      // This allows viewing previous versions and rollback information
      allow read: if isAuthenticated();
      
      // Only admins can create version history entries
      // Version history is automatically created when screens are updated
      allow create: if isAdmin();
      
      // Version history should not be updated or deleted
      // This ensures audit trail integrity
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================================================
    // STAC Metadata Collection (Optional)
    // ============================================================================
    
    match /stac_metadata/{metadataId} {
      // Anyone authenticated can read metadata
      // Metadata includes screen descriptions, tags, categories, etc.
      allow read: if isAuthenticated();
      
      // Only admins can write metadata
      allow write: if isAdmin();
    }
    
    // ============================================================================
    // User Roles Collection
    // ============================================================================
    
    match /user_roles/{userId} {
      // Users can read their own role
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Only admins can read other users' roles
      allow read: if isAdmin();
      
      // Only admins can create or update user roles
      allow create, update: if isAdmin() &&
                              request.resource.data.keys().hasAll(['admin']) &&
                              request.resource.data.admin is bool;
      
      // Only admins can delete user roles
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // Default Deny Rule
    // ============================================================================
    
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
